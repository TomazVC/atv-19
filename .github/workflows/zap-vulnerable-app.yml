name: OWASP ZAP - ClickSeguro App VulnerÃ¡vel

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite executar manualmente

jobs:
  test-vulnerable-app:
    runs-on: ubuntu-latest
    name: Teste com AplicaÃ§Ã£o ClickSeguro VulnerÃ¡vel

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instala dependÃªncias da aplicaÃ§Ã£o
        run: npm install

      - name: Inicia aplicaÃ§Ã£o ClickSeguro em background
        run: |
          echo "ðŸš€ Iniciando aplicaÃ§Ã£o ClickSeguro..."
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          sleep 5

      - name: Verifica se aplicaÃ§Ã£o estÃ¡ respondendo
        run: |
          echo "ðŸ” Verificando se aplicaÃ§Ã£o estÃ¡ ativa..."
          for i in {1..30}; do
            if curl -fsS http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… AplicaÃ§Ã£o ClickSeguro estÃ¡ respondendo!"
              exit 0
            fi
            echo "â³ Tentativa $i/30 - aguardando aplicaÃ§Ã£o..."
            sleep 2
          done
          echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu a tempo."
          exit 1

      - name: OWASP ZAP Baseline Scan na aplicaÃ§Ã£o ClickSeguro
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -m 3 -J clickseguro-zap.json -r clickseguro-zap.html'

      - name: Instala jq para anÃ¡lise dos resultados
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Analisa vulnerabilidades encontradas
        id: vuln-analysis
        run: |
          echo "ðŸ“Š Analisando vulnerabilidades na aplicaÃ§Ã£o ClickSeguro..."
          
          if [ ! -f "clickseguro-zap.json" ]; then
            echo "âŒ Arquivo de resultados nÃ£o encontrado!"
            exit 1
          fi

          # Conta por severidade
          total=$(jq '.site[0].alerts | length' clickseguro-zap.json)
          info=$(jq '[.site[0].alerts[] | select(.riskcode=="0")] | length' clickseguro-zap.json)
          low=$(jq '[.site[0].alerts[] | select(.riskcode=="1")] | length' clickseguro-zap.json)
          medium=$(jq '[.site[0].alerts[] | select(.riskcode=="2")] | length' clickseguro-zap.json)
          high=$(jq '[.site[0].alerts[] | select(.riskcode=="3")] | length' clickseguro-zap.json)
          critical=$(jq '[.site[0].alerts[] | select(.riskcode=="4")] | length' clickseguro-zap.json)

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "critical=$critical" >> $GITHUB_OUTPUT

          # RelatÃ³rio detalhado
          echo "## ðŸŽ¯ Teste com AplicaÃ§Ã£o ClickSeguro VulnerÃ¡vel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Resultados do Scan OWASP ZAP:" >> $GITHUB_STEP_SUMMARY
          echo "| Severidade | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $critical |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $high |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | $medium |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low | $low |" >> $GITHUB_STEP_SUMMARY
          echo "| â„¹ï¸ Info | $info |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$total** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Lista vulnerabilidades crÃ­ticas e altas
          if [ "$high" -gt 0 ] || [ "$critical" -gt 0 ]; then
            echo "### ðŸš¨ Vulnerabilidades CrÃ­ticas/Altas Detectadas:" >> $GITHUB_STEP_SUMMARY
            jq -r '.site[0].alerts[] | select(.riskcode=="3" or .riskcode=="4") | "- **\(.name)** (Risk: \(.riskdesc)) - \(.desc)"' clickseguro-zap.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Lista tipos de vulnerabilidades encontradas
        run: |
          echo "### ðŸ” Detalhes das Vulnerabilidades:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Lista todas as vulnerabilidades com detalhes
          jq -r '.site[0].alerts[] | "#### \(.name) (\(.riskdesc))\n- **DescriÃ§Ã£o:** \(.desc)\n- **SoluÃ§Ã£o:** \(.solution)\n- **URLs Afetadas:** \(.instances | length) instÃ¢ncia(s)\n"' clickseguro-zap.json >> $GITHUB_STEP_SUMMARY

      - name: Verifica se pipeline deve falhar
        run: |
          high=${{ steps.vuln-analysis.outputs.high }}
          critical=${{ steps.vuln-analysis.outputs.critical }}
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [ "$high" -gt 0 ] || [ "$critical" -gt 0 ]; then
            echo "## âŒ PIPELINE FALHOU - VULNERABILIDADES CRÃTICAS DETECTADAS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Motivo:** Foram encontradas $high vulnerabilidades High e $critical vulnerabilidades Critical." >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o:** O deploy foi bloqueado automaticamente por questÃµes de seguranÃ§a." >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:** Corrija as vulnerabilidades e execute o pipeline novamente." >> $GITHUB_STEP_SUMMARY
            
            # Mata a aplicaÃ§Ã£o antes de falhar
            if [ ! -z "$APP_PID" ]; then
              kill $APP_PID 2>/dev/null || true
            fi
            
            exit 1
          else
            echo "## âœ… PIPELINE APROVADO - SEGURANÃ‡A OK" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Nenhuma vulnerabilidade crÃ­tica detectada. Deploy pode prosseguir." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload dos relatÃ³rios (sempre executa)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: clickseguro-security-reports
          path: |
            clickseguro-zap.html
            clickseguro-zap.json
          retention-days: 30

      - name: Finaliza aplicaÃ§Ã£o
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            echo "ðŸ›‘ Finalizando aplicaÃ§Ã£o ClickSeguro (PID: $APP_PID)..."
            kill $APP_PID 2>/dev/null || true
          fi
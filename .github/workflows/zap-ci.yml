name: OWASP ZAP Security Scan - ClickSeguro

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  zap-security-scan:
    runs-on: ubuntu-latest
    name: Scan de SeguranÃ§a com OWASP ZAP

    # Sobe um alvo vulnerÃ¡vel (Juice Shop) para o ZAP escanear
    services:
      juice-shop:
        image: bkimminich/juice-shop:latest
        ports:
          - 3000:3000
        options: >-
          --health-cmd "curl -f http://localhost:3000 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Aguarda o serviÃ§o subir completamente
        run: |
          echo "ðŸš€ Aguardando aplicaÃ§Ã£o responder em http://localhost:3000..."
          for i in {1..60}; do
            if curl -fsS http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo!"
              exit 0
            fi
            echo "â³ Tentativa $i/60 - aguardando..."
            sleep 3
          done
          echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu a tempo."
          exit 1

      # Executa o ZAP Baseline Scan e gera relatÃ³rios HTML e JSON
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -m 5 -J zap-report.json -r zap-report.html'
          # -a = ativa scanners passivos adicionais
          # -m 5 = limita spider por 5 minutos
          # -J = gera relatÃ³rio JSON
          # -r = gera relatÃ³rio HTML

      - name: Instala dependÃªncias para anÃ¡lise
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Analisa severidades e falha se High/Critical
        id: zap-analysis
        run: |
          echo "ðŸ“Š Analisando resultados do scan de seguranÃ§a..."
          
          # Verifica se o arquivo JSON foi gerado
          if [ ! -f "zap-report.json" ]; then
            echo "âŒ Arquivo zap-report.json nÃ£o encontrado!"
            exit 1
          fi

          # Conta alertas por riskcode (0=Info, 1=Low, 2=Medium, 3=High, 4=Critical)
          total=$(jq '.site[0].alerts | length' zap-report.json)
          info=$(jq '[.site[0].alerts[] | select(.riskcode=="0")] | length' zap-report.json)
          low=$(jq '[.site[0].alerts[] | select(.riskcode=="1")] | length' zap-report.json)
          medium=$(jq '[.site[0].alerts[] | select(.riskcode=="2")] | length' zap-report.json)
          high=$(jq '[.site[0].alerts[] | select(.riskcode=="3")] | length' zap-report.json)
          critical=$(jq '[.site[0].alerts[] | select(.riskcode=="4")] | length' zap-report.json)

          # Salva resultados para outros steps
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "info=$info" >> $GITHUB_OUTPUT
          echo "low=$low" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "critical=$critical" >> $GITHUB_OUTPUT

          # Cria resumo para o GitHub Actions
          echo "## ðŸ›¡ï¸ RelatÃ³rio de SeguranÃ§a - ClickSeguro" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Resumo de Vulnerabilidades por Severidade:" >> $GITHUB_STEP_SUMMARY
          echo "| Severidade | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ **Critical** | $critical |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  **High** | $high |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ **Medium** | $medium |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ **Low** | $low |" >> $GITHUB_STEP_SUMMARY
          echo "| â„¹ï¸ **Info** | $info |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$total** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verifica se hÃ¡ vulnerabilidades crÃ­ticas ou altas
          if [ "$high" -gt 0 ] || [ "$critical" -gt 0 ]; then
            echo "âŒ **FALHA DE SEGURANÃ‡A DETECTADA!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Foram encontradas **$high vulnerabilidades High** e **$critical vulnerabilidades Critical**." >> $GITHUB_STEP_SUMMARY
            echo "O deploy foi **BLOQUEADO** por questÃµes de seguranÃ§a." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Verifique o relatÃ³rio HTML nos artefatos para mais detalhes." >> $GITHUB_STEP_SUMMARY
            
            # Falha o job
            echo "âŒ Vulnerabilidades crÃ­ticas detectadas! Bloqueando pipeline..."
            exit 1
          else
            echo "âœ… **Nenhuma vulnerabilidade crÃ­tica detectada!**" >> $GITHUB_STEP_SUMMARY
            echo "Pipeline pode prosseguir com seguranÃ§a." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Identifica tipos de vulnerabilidades mais comuns
        if: always() # Executa mesmo se o step anterior falhar
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Top 10 Vulnerabilidades mais Comuns:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Lista os tipos mais comuns de vulnerabilidades
          jq -r '.site[0].alerts[] | .name' zap-report.json \
            | sort \
            | uniq -c \
            | sort -nr \
            | head -10 \
            | awk '{count=$1; $1=""; name=substr($0,2); printf "- **%s** (%d ocorrÃªncias)\n", name, count }' \
            >> $GITHUB_STEP_SUMMARY

      # Salva os relatÃ³rios como artefatos do GitHub Actions
      - name: Upload dos relatÃ³rios de seguranÃ§a
        uses: actions/upload-artifact@v4
        if: always() # Sempre salva, mesmo se o scan falhar
        with:
          name: relatorio-seguranca-clickseguro
          path: |
            zap-report.html
            zap-report.json
          retention-days: 30

      - name: ComentÃ¡rio final
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **RelatÃ³rios disponÃ­veis nos artefatos:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`zap-report.html\` - RelatÃ³rio visual detalhado" >> $GITHUB_STEP_SUMMARY
          echo "- \`zap-report.json\` - Dados estruturados para automaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Acesse os artefatos na aba **Actions** > **Este workflow** > **Artifacts**" >> $GITHUB_STEP_SUMMARY